<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
    <script src="http://code.createjs.com/easeljs-0.8.0.min.js"></script>
    <script src="jquery.js"></script>
	<script src="kentta.js"></script>

	<script>
	
	// http://stackoverflow.com/questions/9419263/playing-audio-with-javascript
var stage;
var blokinKoko = 50;
var skaalaus = blokinKoko/150;
var painovoima = -0.3;
var hyppypituus = 0;
var nappiPohjassa = false;
var blokkienTiedot = [];
var hyppyPalkki;
var onkoVastausTullut = true;
var omaId;
var url = "http://127.0.0.1:1337/";
var extraHyppy = true;
var laukausAudio = new Audio('http://www.brotherus.net/laukaus.wav');

// pelaajatiedot:
// { 
//	 id1: { hahmoTyyppi: "Veteraani", hahmoBitmap: <bitmap>, 
//          Vaaka: 54, Pysty: 50, xVauhti: 3.6, yVauhti: -2.5, oikealle: true,
//          ampumisviiva: <bitmap>, ampumisLaskuri: 0 }, 
//   id2: { hahmoTyyppi: "HP", ... }, 
//   ...    
// } 
var pelaajaTiedot = {};     




// hae pelaajan "mikko" tiedot ->   pelaajatiedot.mikko
// hae sen pelaajan tiedot, jonka nimi on muuttujassa n ->     pelaajatiedot[n] 

// Lue itse:
// JQuery ajax: http://www.w3schools.com/jquery/jquery_ajax_intro.asp
// NODE.JS tutorial (etsi):
// laita linkki tähän mitä luit:


//Jollakin ohjelmointikerralla alhaalla esitetty tasonluomistapa pitäisi toteuttaa.

window.onload = function() {
    omaId = prompt("Please, insert your gamer ID", "");
    var alkuviesti = { pelaajanimi: omaId, viestityyppi: "aloitus"};
    $.ajaxSetup({
      contentType: "application/json; charset=utf-8"
    });
    $.post (url, alkuviesti, function (serverinVastausTeksti, status){
        var parsittuVastaus = jQuery.parseJSON (serverinVastausTeksti);
		omanHahmonTyyppi = HahmoTyyppi(parsittuVastaus.jarjestys);
		pelaajaTiedot[omaId] = { hahmoBitmap: ukonVisuaalinenLuonti(omanHahmonTyyppi), oikealle: true, 
			hahmotyppi: omanHahmonTyyppi, Vaaka: 0, Pysty: 0, xVauhti: 0, yVauhti: 0};
    });
    //Create a stage by getting a reference to the canvas
    stage = new createjs.Stage("Pelialue");

    TestiTausta = new createjs.Shape();
    TestiTausta.graphics.beginFill("blue").drawRect(0, 0, 1350, 900);
    stage.addChild(TestiTausta);
	makeStage();
            
    // state.update() needs to be called continuously.
    // First update might not show ukkoBitmaps if they are not yet loaded.
    
    setInterval( liikutuskutsu, 20 ); // 20 ms = 50 FPS

    window.onkeydown = NappiAlas;
    
    window.onkeyup = buttonUp;
	
    stage.update();
}

function buttonUp(event) {
	if(event.keyCode == 68 || event.keyCode == 65) {
	    var xVauhti = pelaajaTiedot[omaId].xVauhti;
		var yVauhti = pelaajaTiedot[omaId].yVauhti;
		if(xVauhti == 0 && yVauhti < 0.4){
			var oikealle = ( event.keyCode == 68 );
			hyppysuunta(oikealle, omaId);
		}	
	}

}

function NappiAlas(event) { 
	if(event.keyCode == 68 || event.keyCode == 65) {
		liikutusNappiAlas(event);
        var viesti = {viestityyppi: "ilmoitus", ilmoitustyyppi: "hypynAloitus", pelaaja: omaId};
        $.post(url, viesti, function() {
            //funktio
        } 
        );
	}

	if (event.keyCode == 87 && pelaajaTiedot[omaId].ampumisviiva == undefined){
		ampuminen(omaId);
		var viesti = {viestityyppi: "ilmoitus", ilmoitustyyppi: "ampuminen", pelaaja: omaId};
		$.post(url, viesti, function() { 
            //funktio
        } 
        );	
	}
}

function ampuminen(pelaajaId){

	// Tänne tullaan, jos W-näppäintä painetaan.
	laukausAudio.play();
	var pelaaja = pelaajaTiedot[pelaajaId];
	pelaaja.ampumisviiva = new createjs.Bitmap("Kuva-aineisto/valkoViiva.png")
	var shooting = pelaaja.ampumisviiva;
	shooting.scaleY = 0.25;
	shooting.y = pelaaja.Pysty + 0.5*blokinKoko;
	if(pelaaja.oikealle){
		shooting.x = pelaaja.Vaaka + blokinKoko;
		shooting.scaleX = 1000;
	}else{
		shooting.x = pelaaja.Vaaka;
		shooting.scaleX = -1000;
	};
	stage.addChild(shooting);
	pelaaja.ampumisLaskuri = 0;
};

function liikutusNappiAlas(event){
    /*
    Usko funktion toimivan seuraavalla tavalla.
    
    
    */
	var xVauhti = pelaajaTiedot[omaId].xVauhti;
	var yVauhti = pelaajaTiedot[omaId].yVauhti;
	if (omanHahmonTyyppi == "HP" || omanHahmonTyyppi == "Veteraani"){
        if(xVauhti != 0 && extraHyppy){
            hyppypituus = 2.5;
			var oikealle = ( event.keyCode == 68 );
            hyppysuunta(oikealle, omaId);
            extraHyppy = false;
        }
	}
	if(xVauhti == 0 && yVauhti < 0.4){
		extraHyppy = true;
		if(nappiPohjassa == false){
			hyppyPalkki = new createjs.Bitmap("Kuva-aineisto/hyppy-palkki.png");
			hyppyPalkki.scaleX = 0.33;
			hyppyPalkki.scaleY = 0.33;
			hyppyPalkki.y = pelaajaTiedot[omaId].Pysty + 50;
			stage.addChild(hyppyPalkki);
		}
		nappiPohjassa = true;
	}
}

function hyppysuunta(oikealle,id){
	if(oikealle){ // D, ks. http://www.asciitable.com/
		aloitaHyppy(hyppypituus,+1, id);
	}
	else{ // A
		aloitaHyppy (hyppypituus, -1, id);
	}
}
 
function aloitaHyppy(pituus,suunta, id){ 
	if(suunta == +1){ // oikealle
		pelaajaTiedot[id].oikealle = true;
	}else if(suunta == -1){ // vasemmalle
		pelaajaTiedot[id].oikealle = false;
	};
    pelaajaTiedot[id].yVauhti = -pituus;
    pelaajaTiedot[id].xVauhti = pituus * suunta;
    stage.removeChild(hyppyPalkki);
	nappiPohjassa = false;
	hyppypituus = 0;
}

function XVauhti(id) {
	return pelaajaTiedot[id].XVauhti;
}

function YVauhti(id) {
	return pelaajaTiedot[id].YVauhti;
}

function liikutuskutsu(){
	liikuta(omaId);
	//  TODO: Muuta tätä rutiinia niin, että
	// liikuta-funktiota kutsutaan yksi kerrallaan
	// kaikille pelaajille (myös omalle)
}

function viivapoisto(pelaaja){
	if(pelaaja.ampumisviiva != undefined){
		pelaaja.ampumisLaskuri++;
		if(pelaaja.ampumisLaskuri == 12){
			stage.removeChild(pelaaja.ampumisviiva);
			pelaaja.ampumisviiva = undefined;
			pelaaja.ampumisLaskuri = 0;
		}
	}
}

function liikuta(id) {
	var pelaaja = pelaajaTiedot[id];
    if (pelaaja == undefined) return
	viivapoisto(pelaaja);
    if ( nappiPohjassa ) {
        if(hyppypituus < 10){
            hyppypituus = hyppypituus + 0.1;
        }
        hyppyPalkki.scaleX = hyppypituus * 0.13;
        var hyppyPalkkiLeveys = 39 * hyppyPalkki.scaleX;
        hyppyPalkki.x = pelaaja.Vaaka - 0.5 * hyppyPalkkiLeveys + 25.5;
    }
    var newX = pelaaja.Vaaka + pelaaja.xVauhti;
    var newY = pelaaja.Pysty + pelaaja.yVauhti;
    if( KoskettaakoHahmoMitaanBlokkia( newX, newY ) ) {
        pelaaja.xVauhti = 0;
        pelaaja.yVauhti = 0;
    } else {
        pelaaja.Vaaka = newX;
        pelaaja.Pysty = newY;
        pelaaja.yVauhti = pelaaja.yVauhti - painovoima;
    }

	var bitmap = pelaaja.hahmoBitmap;
	
	bitmap.y = pelaaja.Pysty;
	if ( pelaajaTiedot[id].oikealle ) {
		bitmap.x = pelaaja.Vaaka;
		bitmap.scaleX = skaalaus;
	} else {
		bitmap.x = pelaaja.Vaaka + blokinKoko;
		bitmap.scaleX = -skaalaus;
	}
	
    stage.update();
	
	serverinKeskustelu();
}

function serverinKeskustelu (){
	if( onkoVastausTullut ) {
        onkoVastausTullut = false;
        viesti = {viestityyppi: "kysely", pelaaja: omaId};
		// Lähetetään viesti serverille ja pyydetään kutsumaan
		// "VastausViestinKasittely"-funktiota kun vastaus on tullut.
        $.post(url, viesti, VastausViestinKasittely);
    }; 
}

/*
Esimerkki serveriltä tulevasta viestistä:

{     "Mikko" : { Vaaka: 50, Pysty 80, jarjestys: 2 },
		"Matti" : { Vaaka: 30, Pysty: 100, jarjestys: 1 } 
} */   				
function VastausViestinKasittely(data, status){
	if (data != "{}" ){
        var viestiServerilt = jQuery.parseJSON (data);
        var pelaajanimet = Object.keys(viestiServerilt);

		pelaajanimet.forEach (function (id) {
			if (omaId == id){}
			else if (pelaajaTiedot[id] == undefined){
				// Jos tulee uusi pelaaja tänne päädytään.     A  B     Mies,Nainen
				var jarjestys = viestiServerilt[id].jarjestys;
				var toinenHahmo = HahmoTyyppi(jarjestys);
				hahmoBitmap = ukonVisuaalinenLuonti(toinenHahmo);
				pelaajaTiedot[id] = { bitmap: hahmoBitmap};
			}
			else{
				// Vanha muu pelaaja
				var muidenBtmp = pelaajaTiedot[id].bitmap;
				muidenBtmp.x = viestiServerilt[id].X;
				muidenBtmp.y = viestiServerilt[id].Y;
			}
		});
	};
	setTimeout( function() { onkoVastausTullut = true; }, 20 );
};

function KoskettaakoHahmoMitaanBlokkia( ukkoX, ukkoY ) {
    result = false;
    blokkienTiedot.forEach( function(blokki) {
        if ( KoskettaakoHahmoBlokkia( ukkoX, ukkoY, blokki.x, blokki.y) ) result = true;
    } )
    return result;
}

function KoskettaakoHahmoBlokkia( ux1, uy1, bx1, by1 ) {
    var ux2 = ux1 + blokinKoko;
    var uy2 = uy1 + blokinKoko;
    var bx2 = bx1 + blokinKoko;
    var by2 = by1 + blokinKoko;
    if ( ux1 > bx2 ) return false; // Ukko on kokonaan blokin oikealla puolella
    if ( ux2 < bx1 ) return false; // Ukko on kokonaan blokin vasemmalla puolella
    if ( uy1 > by2 ) return false; // Ukko on kokonaan blokin alapuolella
    if ( uy2 < by1 ) return false; // Ukko on kokonaan blokin yläpuolella
    return true; // Ukko koskettaa blokkia
}

function HahmoTyyppi(jarjestys) {
    if (jarjestys == 1){
		return "HP";
    } else if (jarjestys == 2){
		return "Veteraani";
    } else{
		return "Humanoidi";
	};
}

function ukonVisuaalinenLuonti(characterType){
    if (characterType == "HP"){
        pngNimi = "HulluPilgu.png";
    }else if (characterType == "Veteraani"){
        pngNimi = "Veteraani.png";
    }else{
		pngNimi = "Maskihumanoidi.png";
	};
    var bitmap = new createjs.Bitmap("Kuva-aineisto/" + pngNimi);
    bitmap.scaleX = skaalaus;
    bitmap.scaleY = skaalaus;
    bitmap.x = 0*blokinKoko;
    bitmap.y = 0*blokinKoko;
    stage.addChild(bitmap);
    return bitmap;
};
    
 </script>
</head>
<body>
<canvas id="Pelialue" width="1350" height="900">
</canvas>
</body>
</html>
