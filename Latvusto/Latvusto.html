<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
    <script src="http://code.createjs.com/easeljs-0.8.0.min.js"></script>
    <script src="jquery.js"></script>
  <script src="kentta.js"></script>

  <script>
  
  // http://stackoverflow.com/questions/9419263/playing-audio-with-javascript
var stage;
var pelileveys = 1024;
var pelikorkeus = 650;
var blokinKoko = 50;
var skaalaus = blokinKoko/150;
var painovoima = -0.3;
var hyppypituus = 0;
var nappiPohjassa = false;
var blokkienTiedot = [];
var hyppyPalkki;
var omaId;
var url = "http://www.brotherus.net:8086/";
var extraHyppy = true;
var laukausAudio = new Audio('http://www.brotherus.net/laukaus.wav');
var pelaajaMaassa = false;
var aloitusSuoritettu = false; 

// pelaajaTiedot:
// { 
//   id1: { pelaajaTiedot[omaId].hahmotyyppi: "Veteraani", hahmoBitmap: <bitmap>, 
//          Vaaka: 54, Pysty: 50, xVauhti: 3.6, yVauhti: -2.5, oikealle: true,
//          ampumisviiva: <bitmap>, ampumisLaskuri: 0, elossa: true }, 
//   id2: { pelaajaTiedot[omaId].hahmotyyppi: "HP", ... }, 
//   ...    
// } 
var pelaajaTiedot = {};     


// 1024 x 768
// hae pelaajan "mikko" tiedot ->   pelaajaTiedot.mikko
// hae sen pelaajan tiedot, jonka nimi on muuttujassa n ->     pelaajaTiedot[n] 

// Lue itse:
// JQuery ajax: http://www.w3schools.com/jquery/jquery_ajax_intro.asp
// NODE.JS tutorial (etsi):
// laita linkki t‰h‰n mit‰ luit:


//Jollakin ohjelmointikerralla alhaalla esitetty tasonluomistapa pit‰isi toteuttaa.

  //var pelaajanimet = Object.keys(pelaajaTiedot);
  //pelaajanimet.forEach (function (id){
  //  liikuta(id)

window.onload = function() {
    //Create a stage by getting a reference to the canvas
    stage = new createjs.Stage("Pelialue");

    TestiTausta = new createjs.Shape();
    
    
    TestiTausta.graphics.beginFill("blue").drawRect(0, 0, pelileveys, pelikorkeus);
    stage.addChild(TestiTausta);
    makeStage();
}

function selviytymispisteasetus(){
    $("#Survivability").text("Selviytymisprosenttina " + pelaajaTiedot[omaId].selviytyminen + "%");
    var random1to100 = Math.floor(Math.random() * 100);
    if(random1to100 > pelaajaTiedot[omaId].selviytyminen){
        $("#Survivability").text(omaId + " neutralisoitu!");
        var viesti = {pelaaja: omaId, viestityyppi: "ilmoitus", ilmoitustyyppi: "neutralisoituminen"};
        pelaajaTiedot[omaId].elossa = false;
        $.post(url, viesti);
    }
}

function aloitaPeli(){
    omaId = $("#pelaajaNimi").val();
    var alkuviesti = { pelaaja: omaId, viestityyppi: "aloitus"};
    $.ajaxSetup({
      contentType: "application/json; charset=utf-8"
    });
    $.post (url, alkuviesti, function (serverinVastausTeksti, status){
        console.log("ALKUVIESTI RESPONSE SAATU");
        var parsittuVastaus = jQuery.parseJSON (serverinVastausTeksti);
        var hahmotyyppi = hahmotyypinValinta(parsittuVastaus.jarjestys);
        pelaajaTiedot[omaId] = { hahmoBitmap: ukonVisuaalinenLuonti(hahmotyyppi), oikealle: true, 
          hahmotyyppi: hahmotyyppi, Vaaka: 3 * blokinKoko, Pysty: 0, xVauhti: 0, yVauhti: 0, selviytyminen: 100,
          elossa: true};
        selviytymispisteasetus();
        
        var muidenPelaajienTiedot = parsittuVastaus.muidenPelaajienTiedot;
        var pelaajanimet = Object.keys(muidenPelaajienTiedot);
        var toisenHahmonJarjestys = 1;
        pelaajanimet.forEach(function(pelaajanimi){
          if(pelaajanimi != omaId){
            toisenHahmonLuonti(toisenHahmonJarjestys, pelaajanimi);
            toisenHahmonJarjestys++;
          }
        });
        aloitusSuoritettu = true;
    });
            
    // state.update() needs to be called continuously.
    // First update might not show ukkoBitmaps if they are not yet loaded.
    
    setInterval( liikutuskutsu, 20 ); // 20 ms = 50 FPS

    window.onkeydown = NappiAlas;
    
    window.onkeyup = buttonUp;
  
    stage.update();
    console.log("STAGE.UPDATE suoritettu!")
  
    kysyServeriltTapahtumia();
    
}

function NappiAlas(event) { 
    if(aloitusSuoritettu == false)return;
    if(pelaajaTiedot[omaId].elossa == false) return;
    if(event.keyCode == 68 || event.keyCode == 65) {
        liikutusNappiAlas(event);
    }

    if (event.keyCode == 87 && pelaajaTiedot[omaId].ampumisviiva == undefined){
        ampuminen(omaId);
        var viesti = {viestityyppi: "ilmoitus", ilmoitustyyppi: "ampuminen", pelaaja: omaId, 
            hahmonX: pelaajaTiedot[omaId].Vaaka, hahmonY: pelaajaTiedot[omaId].Pysty};
        $.post(url, viesti);  
    }
}

function buttonUp(event) {
    if(event.keyCode == 68 || event.keyCode == 65) {
        var xVauhti = pelaajaTiedot[omaId].xVauhti;
        var yVauhti = pelaajaTiedot[omaId].yVauhti;
        if(pelaajaMaassa){
            var oikealle = ( event.keyCode == 68 );
            hyppaaSuuntaan(oikealle, omaId);
            pelaajaMaassa = false;
        }  
    }
}

function maailmastaVisuaaliseen(maailmaX, maailmaY){
	var visX = maailmaX + (pelileveys * 0.5 - pelaajaTiedot[omaId].Vaaka);
	var visY = maailmaY + (pelikorkeus * 0.5 - pelaajaTiedot[omaId].Pysty);
	return [visX, visY];
}

function visuaalisestaMaailmaan(visX, visY){
	var maailmaX = visX - (pelileveys * 0.5 - pelaajaTiedot[omaId].Vaaka);
	var maailmaY = visY - (pelikorkeus * 0.5 - pelaajaTiedot[omaId].Pysty);
	return [maailmaX, maailmaY];
}

function ampuminen(pelaajaId){
    // T‰nne tullaan, jos W-n‰pp‰int‰ painetaan.
    laukausAudio.play();

    var pelaaja = pelaajaTiedot[pelaajaId];
	var viivatsekkausY = pelaaja.Pysty + 0.5 * blokinKoko;
    var suuntanumero = pelaaja.oikealle ? 0.5 : -0.5;
    var viivatsekkausX = pelaaja.Vaaka + suuntanumero * blokinKoko;
    var ampumisskaalaus = 0;
    while(KoskettaakoHahmoMitaanBlokkia(viivatsekkausX, viivatsekkausY, 1, 1, 0, 0) == ""){
        viivatsekkausX = viivatsekkausX + suuntanumero * blokinKoko;
        ampumisskaalaus = ampumisskaalaus + 0.5 * blokinKoko;
    }

    pelaaja.ampumisviiva = new createjs.Bitmap("Kuva-aineisto/valkoViiva.png")
    var shooting = pelaaja.ampumisviiva;
    shooting.scaleY = 0.25;
    if(pelaaja.oikealle){
        shooting.x = pelaaja.Vaaka + blokinKoko;
        shooting.scaleX = ampumisskaalaus * 0.5;
    } else {
        shooting.x = pelaaja.Vaaka;
        shooting.scaleX = -ampumisskaalaus * 0.5;
    }
	var ampuminenMaailmassa = [pelaaja.oikealle ? pelaaja.Vaaka + blokinKoko : pelaaja.Vaaka, viivatsekkausY];
	var shootingVis = maailmastaVisuaaliseen(
		ampuminenMaailmassa[0], ampuminenMaailmassa[1]);
	shooting.x = shootingVis[0];
	shooting.y = shootingVis[1]; 	
    stage.addChild(shooting);
    pelaaja.ampumisLaskuri = 0;
    var pelaajanimet = Object.keys(pelaajaTiedot);
    pelaajanimet.forEach(function(ammuttava){
        if(ammuttava != pelaajaId){
            var uhri = pelaajaTiedot[ammuttava];
            var distance = Math.abs(uhri.Vaaka - pelaaja.Vaaka);
            if((pelaaja.oikealle && ampuminenMaailmassa[0] < uhri.Vaaka + blokinKoko || !pelaaja.oikealle && ampuminenMaailmassa[0] > uhri.Vaaka) && distance < ampumisskaalaus){
				console.log("X-suunnassa onnistuu!");
                if(ampuminenMaailmassa[1] < uhri.Pysty + blokinKoko + 1 && ampuminenMaailmassa[1] > uhri.Pysty - 1){
					console.log("Y-suunnassa onnistuu");
                    var distanceDivided = Math.floor(distance / blokinKoko);
                    var falloff = distanceDivided > 3 ? 3 : distanceDivided;
					var armori = uhri.hahmotyyppi == "Humanoidi" ? 3 : 0; 
                    uhri.selviytyminen = uhri.selviytyminen - (10 - falloff - armori);
                    selviytymispisteasetus();
                }
            }
        }
    })
}

function liikutusNappiAlas(event){
    var xVauhti = pelaajaTiedot[omaId].xVauhti;
    var yVauhti = pelaajaTiedot[omaId].yVauhti;
    if (pelaajaTiedot[omaId].hahmotyyppi == "Veteraani"){
        if(!pelaajaMaassa && extraHyppy){
            hyppypituus = 2.5;
            var oikealle = ( event.keyCode == 68 );
            hyppaaSuuntaan(oikealle);
            extraHyppy = false;
        }
    }
    if(pelaajaMaassa){
        extraHyppy = true;
        if(nappiPohjassa == false){
            hyppyPalkki = new createjs.Bitmap("Kuva-aineisto/hyppy-palkki.png");
            hyppyPalkki.scaleX = 0.33;
            hyppyPalkki.scaleY = 0.33;
            hyppyPalkki.y = pelikorkeus * 0.5 + blokinKoko;
            stage.addChild(hyppyPalkki);
        }
        nappiPohjassa = true;
    }
}

function hyppaaSuuntaan(oikealle){
    var suunta = -1;
    if ( oikealle ) suunta = +1;
    if(pelaajaTiedot[omaId].hahmotyyppi == "Humanoidi") {
        hyppypituus = hyppypituus / 10 * 15;
    }
    var viesti = {pelaaja: omaId, viestityyppi: "ilmoitus", ilmoitustyyppi: "hyppy", hyppypituus: hyppypituus, 
        suunta: suunta, hahmonX: pelaajaTiedot[omaId].Vaaka, hahmonY: pelaajaTiedot[omaId].Pysty};
    $.post(url, viesti);  
    aloitaHyppy(hyppypituus, suunta, omaId);
    nappiPohjassa = false;
    hyppypituus = 0;
    stage.removeChild(hyppyPalkki);
}
 
function aloitaHyppy(pituus, suunta, id){
    if(suunta == +1){ // oikealle
        pelaajaTiedot[id].oikealle = true;
    } else if(suunta == -1){ // vasemmalle
        pelaajaTiedot[id].oikealle = false;
    }
    pelaajaTiedot[id].yVauhti = -pituus;
    pelaajaTiedot[id].xVauhti = pituus * suunta;
}

function XVauhti(id) {
    return pelaajaTiedot[id].XVauhti;
}

function YVauhti(id) {
    return pelaajaTiedot[id].YVauhti;
}

function liikutuskutsu(){
    if(aloitusSuoritettu == false)return;
    var pelaajanimet = Object.keys(pelaajaTiedot);
    pelaajanimet.forEach (function (id){
        liikuta(id);
    })
    var latauskerroin = 1;
    if(pelaajaTiedot[omaId].hahmotyyppi == "HP"){
        latauskerroin = 1.25;
    } else if(pelaajaTiedot[omaId].hahmotyyppi == "Humanoidi"){
        latauskerroin = 0.666;
    }
  
    if ( nappiPohjassa ) {
        if(hyppypituus < 10){
           hyppypituus = hyppypituus + 0.4 * latauskerroin;
        }
        hyppyPalkki.scaleX = hyppypituus * 0.13;
        var hyppyPalkkiLeveys = 39 * hyppyPalkki.scaleX;
        var pelaaja = pelaajaTiedot[omaId];
        hyppyPalkki.x = pelileveys * 0.5 + blokinKoko * 0.5 - hyppyPalkkiLeveys * 0.5;
    }
    stage.update();
}

function viivapoisto(pelaaja){
    if(pelaaja.ampumisviiva != undefined){
        pelaaja.ampumisLaskuri++;
        if(pelaaja.ampumisLaskuri == 6){
            stage.removeChild(pelaaja.ampumisviiva);
        }
        if(pelaaja.ampumisLaskuri == 12){
            pelaaja.ampumisviiva = undefined;
            pelaaja.ampumisLaskuri = 0;    
        }
    }
}

function liikuta(id) {
    var pelaaja = pelaajaTiedot[id];
    if (pelaaja == undefined) return;
    viivapoisto(pelaaja);
    var newX = pelaaja.Vaaka + pelaaja.xVauhti;
    var newY = pelaaja.Pysty + pelaaja.yVauhti;
    var kosketustsekkaus = KoskettaakoHahmoMitaanBlokkia( newX, newY, blokinKoko, blokinKoko, pelaaja.Vaaka, pelaaja.Pysty );
    if(pelaaja.elossa && kosketustsekkaus != "") {
        if (kosketustsekkaus == "x") {
            // sivusein‰kosketus
            pelaaja.xVauhti = 0;            
        } else {
            // lattiakosketus
            pelaaja.xVauhti = 0;
            pelaaja.yVauhti = 0;    
            if ( omaId == id ) pelaajaMaassa = true;
        }
    } else {
        pelaaja.Vaaka = newX;
        pelaaja.Pysty = newY;
        pelaaja.yVauhti = pelaaja.yVauhti - painovoima; 
        if(omaId == id){
            blokkienTiedot.forEach(function (blokki){
				var vis = maailmastaVisuaaliseen(blokki.x, blokki.y);
                blokki.bitmap.x = vis[0];
                blokki.bitmap.y = vis[1];
            }) 
        }
    }

    var bitmap = pelaaja.hahmoBitmap;
    if(id == omaId){
        bitmap.x = pelileveys * 0.5;
        bitmap.y = pelikorkeus * 0.5;
    } else {
		var vis = maailmastaVisuaaliseen(pelaaja.Vaaka, pelaaja.Pysty)
        bitmap.x = vis[0];
        bitmap.y = vis[1];
    }	
    bitmap.scaleX = pelaaja.oikealle ? skaalaus : -skaalaus; 
	if(!pelaaja.oikealle){
		bitmap.x = bitmap.x + blokinKoko;
	}
    if(pelaaja.elossa == false){
        bitmap.scaleY = -skaalaus;
    }   
}

//KoskettaakoHahmoBlokkia: "x-kosketus", "y-kosketus", "ei-kosketusta"
function KoskettaakoHahmoMitaanBlokkia( ukkoX, ukkoY, leveys, korkeus, viimeX, viimeY ) {
    var kosketus = "";
    blokkienTiedot.forEach( function(blokki) {
        if(kosketus != "y" && kosketus != "x")
            kosketus = KoskettaakoHahmoBlokkia( ukkoX, ukkoY, leveys, korkeus, blokki.x, blokki.y, viimeX, viimeY);
    } )
    return kosketus;
}

// KoskettaakoHahmoBlokkia: "x-kosketus", "y-kosketus", "ei-kosketusta"
function KoskettaakoHahmoBlokkia( ux1, uy1, leveys, korkeus, bx1, by1, viimeX, viimeY ) {

    var ux2 = ux1 + leveys;
    var uy2 = uy1 + korkeus;
    var bx2 = bx1 + blokinKoko;
    var by2 = by1 + blokinKoko;
    if ( ux1 > bx2 ) return "";
    if (ux2 < bx1) return "";
    if(uy1 > by2) return "";
    if(uy2 < by1) return "";
    if(viimeX + leveys < bx1 || viimeX > bx2) return "x";
    return "y";
}

function kysyServeriltTapahtumia (){
    viesti = {viestityyppi: "kysely", pelaaja: omaId};
  // L‰hetet‰‰n viesti serverille ja pyydet‰‰n kutsumaan
  // "VastausViestinKasittely"-funktiota kun vastaus on tullut.
    $.post(url, viesti, VastausViestinKasittely);
}

/*
Esimerkki serverilt‰ tulevasta viestist‰:

{     "Mikko" : { Vaaka: 50, Pysty 80, jarjestys: 2 },
    "Matti" : { Vaaka: 30, Pysty: 100, jarjestys: 1 } 
} */           
function VastausViestinKasittely(data, status){
    //console.log("Viesti vastaanotettu: " + data); 
    var viestiServerilt = jQuery.parseJSON (data);
    var toinenPelaaja = viestiServerilt.pelaaja;
    if(viestiServerilt.viestityyppi == "aloitus"){
        //console.log("Aloitus, pelaajana " + toinenPelaaja + "   J‰rjestys: " + viestiServerilt.jarjestys);
        toisenHahmonLuonti(viestiServerilt.jarjestys, toinenPelaaja);    
    } else if(viestiServerilt.viestityyppi == "ilmoitus"){
        if(viestiServerilt.ilmoitustyyppi == "ampuminen" || viestiServerilt.ilmoitustyyppi == "hyppy"){
            alieeniclientinHyppyJaAmpuminen(viestiServerilt);
        }else if(viestiServerilt.ilmoitustyyppi == "neutralisoituminen"){
            neutralisoituminen(viestiServerilt);
        }
    }
    kysyServeriltTapahtumia();
}

function neutralisoituminen(viestiServerilt){
    var pelaajannimi = viestiServerilt.pelaaja;
    pelaajaTiedot[pelaajannimi].elossa = false;
}

function alieeniclientinHyppyJaAmpuminen(vS){
    var Vaaka = Number(vS.hahmonX);
    var Pysty = Number(vS.hahmonY);
    var pelaajanNimi = vS.pelaaja;
    pelaajaTiedot[pelaajanNimi].Vaaka = Vaaka;
    pelaajaTiedot[pelaajanNimi].Pysty = Pysty;
    if(vS.hyppypituus != undefined){
        aloitaHyppy(vS.hyppypituus, vS.suunta, pelaajanNimi);
    }else{
        //var viesti = {viestityyppi: "ilmoitus", ilmoitustyyppi: "ampuminen", pelaaja: omaId};
        ampuminen(pelaajanNimi);
    }
}

function toisenHahmonLuonti(jarjestys, toinenPelaaja){
    var hahmotyyppi = hahmotyypinValinta(jarjestys);
    pelaajaTiedot[toinenPelaaja] = { hahmoBitmap: ukonVisuaalinenLuonti(hahmotyyppi),
        oikealle: true, hahmotyyppi: hahmotyyppi, Vaaka: 0, Pysty: 0, xVauhti: 0, yVauhti: 0, selviytyminen: 100,
        elossa: true};
}

function hahmotyypinValinta(jarjestys) {
    if (jarjestys == 1){
        return "HP";
    } else if (jarjestys == 2){
        return "Veteraani";
    } else{
        return "Humanoidi";
    }
}

function ukonVisuaalinenLuonti(characterType){
    if (characterType == "HP"){
        pngNimi = "HulluPilgu.png";
    }else if (characterType == "Veteraani"){
        pngNimi = "Veteraani.png";
    }else{
        pngNimi = "Maskihumanoidi.png";
    }
    var bitmap = new createjs.Bitmap("Kuva-aineisto/" + pngNimi);
    bitmap.scaleX = skaalaus;
    bitmap.scaleY = skaalaus;
    bitmap.x = 0*blokinKoko;
    bitmap.y = 0*blokinKoko;
    stage.addChild(bitmap);
    return bitmap;
}

function resetointi(){
    var viesti = {viestityyppi: "resetointi"};
    $.post(url, viesti);
}
    
 </script>
</head>
<body>
Nimi <input type="text" id="pelaajaNimi"/>
<button onClick = "aloitaPeli()">Aloita</button>
<button onclick = "resetointi()">Resetointi</button>
<span id = "Survivability"></span>
<br>
<canvas id="Pelialue" width="1024" height="650">
</canvas>
</body>
</html>
